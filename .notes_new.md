# Масштабирование процесса непрерывной интеграции

##### Андрей:
 Мы живем в интересное время...
 Еще каких то 5 лет назад я мечтал распаралелить все мои 70 Selenium тестов,
 для того чтоб получать информацию о сборке не за 5 часов а хотя бы за час,
 я мечтал о выделенной виртуалке с докером чтоб на ней развернуть selenium grid и спавнить ноды.
 Но все что было у меня это бесплатная версия тимсити и агенты/тестовое окружение которые делили одну виртуалку.
 Я не мог даже и мечтать построить непрерывную интеграцию...

##### Дима:
 И не говори я тоже мечтал что наступит время когда каждый сможет иметь выделенное окружения
 для тестирования и разработки, когда тесты перестанут падать из-за того что кто-то деплоит новую версию на окружении
 во время прогона регрессии. И вот свершилось, мы встретились в этой компании и что мы видим? Микросервисы, Облака,
 сотни агентов у Jenkins'а. Разумеется в таких тепличных условиях мы смогли реализовать CI для нашего миросервиса
 и мы даже задумывались о внедрении CD, ведь все что от нас требовалось это следовать простым принципам
    
# Принципы CI/CD

##### Дима:
 Встроенное качество/Build-in Quality - Тесты должны быть частью продукта
 и обратная связь от них должна быть быстрой иначе ими никто не будет пользоваться
        
 Ответственность/Everyone is Responsible - Вся команда должна работать на результат.
 Не должно быть ситуаций когда разработчики играют в пинг-поинг тестировщиками. Видим проблему - решаем проблему! 

 Все в виде кода/Version Control Everything - Конфигурация, документация, миграции, все - все должно быть кодом.
    
 Автоматизация/Automate Everything - Сборка, тестирование, релизы, изменения конфигураций, деплой -
 все должно быть автоматизированно! Ручные операции - зло, даже одна ручная операция может сломать весь процесс.
    
 Совершенствование/Continuous Improvement - Никогда не нужно останавливаться на достигнутом, Совершенству нет предела!
 
     Встроенное качество/Build-in Quality
     Create short feedback loops to deal with bugs as soon as they are created.
     By having issues looped back to developers as soon as they fail post-build test, it will enable them to produce higher quality code quicker.
     In addition, fewer issues will be found later on in the process, when it will be more expensive to fix.
 
     Ответственность/Everyone is Responsible
     In high performing organizations, nothing is “somebody else’s problem.”
     Developers are responsible for the quality and stability of the software they build.
     Operations teams are responsible for helping developers build quality in.
     Everyone works together to achieve the organizational level goals, rather than optimizing for what’s best for their team or department.
 
     Все в виде кода/Version Control Everything
     Code, configuration, scripts, databases, documentation. Everything!
     Having one source of truth – and a reliable one – gives you a stable foundation to build your processes upon.
 
     Автоматизация/Automate Everything
     Automate your builds, your testing, your releases, your configuration changes and everything else.
     Manual processes are inherently less repeatable, more prone to error and less efficient.
     Once you automate a process, less effort is needed to run it and monitor its progress – and it will ensure you get consistent results.
 
     Совершенствование/Continuous Improvement
     Continuous improvement, or kaizen in Japanese, is another key idea from the Lean movement. Taiichi Ohno, a key figure in the history of the Toyota company, once said,
 
         Kaizen opportunitites are infinite. Don’t think you have made things better than before and be at ease…
         This would be like the student who becomes proud because they bested their master two times out of three in fencing.
         Once you pick up the sprouts of kaizen ideas, it is important to have the attitude in our daily work that just underneath one kaizen idea is yet another one.
 
     Don’t treat transformation as a project to be embarked on and then completed so we can return to business as usual.
     The best organizations are those where everybody treats improvement work as an essential part of their daily work, and where nobody is satisfied with the status quo.
 
# CI/CD это просто

##### Андрей:
 [Верхнеуровнего описать процесс разработки арка]
 Действительно реализовать CD для миросервиса очень просто:
 
 Сборка - Пакуем его в контейнер
  
 Тестирование - Пишем сотню тестов на него, этож микросервис в чем проблема автоматизировать 4-5 ендпойнтов,
  Автоматизируем процесс сборки и запуска тестов -> Jenkins pipeline. 
  
 Развертывание - Задеплоить контейнер не проблема. Docker Mesos Marathon k8s
 
 Повторить - И разумеется повторяем. Пока тестов 100-200 и выполняются они за 5 мин. нет проблемы это все повторить.
 
 
##### Дима:
 Мы построили свой маленький уютный мир розовых пони и единорогов... Но мы живем в реальном мире и он ужасен...
 Наверное у каждой компании есть СЕРВИС которым програмисты пугают друг друга? Так вот у нас в компании тестировщики 
 пугают друг дргу регресионным окружением для API платформы. Чтоб понять почему оно страшное надо немного расказать про
 то что же мы разрабатываем и тестируем. 
 
# Сервис интернет-телефонии

##### Андрей:
 Мы разрабатываем облачную систему комуникации, звонки видеоконференции командный мессенджер контакт центр,
 Мы даже умеем отправлять MMS и Факсы!
  
 И да наша система построенна на принципах SOA  

# Архитектура

##### Андрей:
 На данный момент у нас более 170 сервисов... И нам сказали построить CD для сердца нашей API платформы.

# Платформа API

##### Андрей:
 API платформа предоставляет возможность нашим внутренним и внешним разработчикам а так же другим компаниям
 интегрироваться с нашей системой.
 На данный момент платформа насчитывает порядка 35 сервисов, которые разрабатывают 60 человек (7 команд).
 
 [Показать что говорить то мы будем про сервис над которым работают все 7 команд]

# Окружения 
 У нас очень сложное окружение, хоть мы и разрабатываем 35 сервисов, для того чтоб все работало нам нужно задеплоить 80 сервисов.
 И да у каждой команды есть свое выделенное окружение а так же 3 окружения для релизных активностей
 и непрерывной интеграции.
 
 [Вопрос залу]
 Как вы думайте сколько времени занимает деплой 80 сервисов?
 Когда я только пришел в компанию мне предложили самому попробовать обновить его, и это заняло 2 недели!
 
 Разумеется поддерживать такую инфраструктуру каманда разработки не сможет, кто-то же должен писать новый код
 и тестировать его! И ладно в платформе окружений 10, если посмотреть в масштабах компании их около СОТНИ... 
 и их нужно поддерживать а это значит без выделенной команды которая только и будет что поддерживать тестовые окружения
 не обойтись! И все равно, несмотря на выделенную команду мы тоже поддерживаем эти окружения.  

# Регрессия
##### Андрей:
 А выглядит оно очень просто:
 1) обновляем окружение до необходимого состояния
 2) Проверяем что оно работает
 3) Готовим тестовые данные, а это тот еще квест, разложить все по десяткам баз данных и синхронизировать. Мы даже написали отдельный сервис 
    который этим занимается.
 4) Запускаем 18 000 e2e тестов
  
 И все-го то через 2 часа мы могли бы получить результат... 
 Но очень часто тесты падают из-за проблем с окружением
 
 Тест не упавший 5 раз не упал! 
 
 А что если в итоге упадет даже 1-2% тестов, разобрать 360 тестов не так то и просто,
  как следствие регрессия занимает 2-3 дня!
  
 О каком процессе непрерывной поставки можно говорить если у нас по факту у нас есть только 1 окружение
 результатам которого мы доверяем и регрессия на нем занимает до 3 дней?

# Постоянная доступность

##### Дима:
 А еще у нас "Соглашение об уровне услуг 99 999" это значит что все и всегда должно работать! 
 BC больше регрессии для бога регрессии

# Постановка

##### Дима:
 И этот сервис нам нужно поставлять на продакшен хотя бы за 1 день!
 а ведь над ним работают 60 человек -> десятки изменений в день!

 Очевидно что проблема с тестированием, как сильно их не паралель, за 5 минут они не пройдут, потому что они запускаются
 против одного окружения.
 Но и построить десяток окружений для непрерывной интеграции тоже не получится.
 
 Как отмасштабировать тесты и процесс непрерывной интеграции? чтоб поставлять любое изменение хотя бы за 1 день?
 
##### Андрей: 
 Если с окружениями столько проблем почему бы от него не отказаться?
 Давай тестировать без окружений! Ведь существоет множество техник тестирования бекенда.
 


