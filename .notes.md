# Масштабирование процесса непрерывной интеграции

##### Андрей:
 Мы живем в интересное время...
 Еще каких то 5 лет назад я мечтал распаралелить все мои 70 Selenium тестов,
 для того чтоб получать информацию о сборке не за 5 часов а хотя бы за час,
 я мечтал о выделенной виртуалке с докером чтоб на ней развернуть selenium grid и спавнить ноды.
 Но все что было у меня это бесплатная версия тимсити и агенты/тестовое окружение которые делили одну виртуалку.
 Я не мог даже и мечтать построить непрерывную интеграцию...

##### Дима:
 И не говори я тоже мечтал что наступит время когда каждый сможет иметь выделенное окружения
 для тестирования и разработки, когда тесты перестанут падать из-за того что кто-то деплоит новую версию на окружении
 во время прогона регрессии. И вот свершилось, мы встретились в этой компании и что мы видим? Облака, сотни агентов у
 Jenkins'а. Разумеется в таких тепличных условиях мы смогли реализовать CI для нашего проекта
 и мы даже задумывались о внедрении CD, ведь все что от нас требовалось это следовать простым принципам
    
# Принципы CI/CD

##### Дима:
 Встроенное качество/Build-in Quality - Тесты должны быть частью продукта
 и обратная связь от них должна быть быстрой иначе ими никто не будет пользоваться
        
 Ответственность/Everyone is Responsible - Вся команда должна работать на результат.
 Не должно быть ситуаций когда разработчики играют в пинг-поинг тестировщиками. Видим проблему - решаем проблему! 

 Все в виде кода/Version Control Everything - Конфигурация, документация, миграции, все - все должно быть кодом.
    
 Автоматизация/Automate Everything - Сборка, тестирование, релизы, изменения конфигураций, деплой -
 все должно быть автоматизированно! Ручные операции - зло, даже одна ручная операция может сломать весь процесс.
    
 Совершенствование/Continuous Improvement - Никогда не нужно останавливаться на достигнутом, Совершенству нет предела!
 
# CI/CD это просто

##### Андрей:
 Мы работали(работаем) в команде из 6 человек, 3 разработчика, 2 тестировщика и тимлид. Мы разрабатывали(разрабатываем)
 микросервис для асинхронных операций
 
 Сборка - Что может быть проще чем положить jar'ник в контейнер с java и запушить его в regestry,
  (c этим даже программист может справится/gradle build или maven build + подключить плагин)
  
 Тестирование - Мы написали тесты, этож микросервис в чем проблема автоматизировать 4-5 ендпойнтов, мы объединили
  это все в папйлайн и сборка + тестирование у нас занимало/занимает каких то 5 минут.
  
 Развертывание - Задеплоить контейнер не проблема, но у нас есть своя система для деплоя, так как у нас не только
  контейнеры но и виртуальные машины на linux/windows а единый способ деплоя для всего в больших системах просто необходим.
  Но и с этой задачей мы справились!  

 Кажется пришло время внедрить это решение и мы собрали митинг, продемонстрировали наше решение...
 
##### Дима:
 Но как оказалось просто так задеплоить в продакшн ничего нельзя.
 Наше соглашение об уровне предоставления услуг подразумевает доступность пять девяток и для поддержки 
 такого уровня у нас реализованны "почти" все процессы описанные в ITSM (IT Service Management) а именно:
 1) управления инцидентами
 2) управления проблемами
 3) управления конфигурациями
 4) управления изменениями
 5) управления релизами
 6) управления доступностью
 
 То есть процесс несколько сложнее чем нам казалось, а до кучи никому не интересно внедрение CD для нашего микросервиса.
 Он уже на продакшене, и ни у кого нет планов вносить в него изменения...  

##### Андрей:
 Тем не менее мы смогли всех заинтриговать данным подходом и нам предложили построить CD для сердца нашей API платформы
 А это не микросервис у которого 1-2 интеграции. (Переход на продукт)
 
# Сервис интернет-телефонии

##### Андрей:
 Мы разрабатываем облачную систему комуникации, звонки видеоконференции командный мессенджер контакт центр,
 Мы даже умеем отправлять MMS и Факсы!
  
 И да наша система построенна на принципах SOA   
 
# Архитектура
  
##### Андрей:
 На данный момент у нас более 170 сервисов... А строить CD мы будем для сервиса который предоставляет большую часть API.

# Платформа API

##### Андрей:
 Вот он (показать на PAS), помимо сервиса я так же подсветил сервисы с которыми он непосредственно взаимодействует.
 API платформа предоставляет возможность нашим внутренним и внешним разработчикам а так же другим компаниям
 интегрироваться с нашей системой.
 На данный момент платформа насчитывает порядка 35 сервисов, которые разрабатывают 60 человек (7 команд).
 
 [показать масштаб, микросервис vs платформа, указать что тут уже масштаб чувствуется]

##### Дима: 
 И  для разработки и для тестирования нам разумеется требуется окружение:
 
# Тестовые окружения

##### Дима:
 Оно очень сложное, хоть мы и разрабатываем 35 сервисов, для того чтоб все работало нам нужно задеплоить 80 сервисов.
 И да у каждой команды есть свое выделенное окружение а так же 3 окружения для релизных активностей
 и непрерывной интеграции.
 
 [Вопрос залу]
 Как вы думайте сколько времени занимает деплой 80 сервисов?
 2 дня работы инженера, если в дата центре есть ресурсы, ведь это не 2 ядра 4 гига, это 130 вируальных ядер,
 180 GB оперативной памяти. А если их нет? то тут уж как повезет, ведь поставка нового оборудовоания в датацентр
 и интеграция его в нашу систему может занять до полу года.
 
 Разумеется поддерживать такую инфраструктуру каманда разработки не сможет, кто-то же должен писать новый код
 и тестировать его! И ладно в платформе окружений 10, если посмотреть в масштабах компании их около СОТНИ... 
 и их нужно поддерживать а это значит без выделенной команды которая только и будет что поддерживать тестовые окружения
 не обойтись!
 
 Обновление даже одного сервиса в распределенной системе это всегда боль!
 1) Вам нужно найти все сервисы которые с ним взаимодействуют
 2) Вам нужно найти все сервисы с которыми он взаимодействуют
 3) Проверить не требуется ли обновление этих сервисов
 4) вернуться к пункту 1
 5) Задеплоить все в правильном попрядке
 6) Проверить работает ли после деплоя окружения (прогнать PDV для окружения)
 
 И не дай бог что-то не работает, пойди потом найди проблему!
 Как же по вашему выглядит регрессионное тестирвоание на таком окружении?      
 
# Регрессионное тестирование

##### Андрей:
 А выглядит оно очень просто:
 1) обновляем окружение до необходимого состояния
 2) Проверяем что оно работает (вообщем все что Дима уже расказал)
 3) Готовим тестовые данные, а это тот еще квест, разложить данные по десяткам баз. Мы даже написали отдельный сервис 
    который этим занимается.
 4) Запускаем 18 000 e2e тестов
 
 И все-го то через 2 часа мы могли бы получить результат...
 [Вопрос залу]
 Почему могут падать тесты? 
 1) Они нашли баг
 2) Проблемы с окружением/что-то не додеплоили или заделоили не то/ какой то сервис упал по непонятным причинам
 3) Проблемы с тестом
  
 А почему могут падать тесты если мы их распаралелим (200 rps / 1 500 000 запросов за регрессию,
  более 100 паралельных тестов)
 1) Проблемы с тестом - тесты начинаю мешать друг другу
 2) Проблемы с окружением, где то таймаут слишком маленький и из-за нагрузки что-то может не работать (это же уменьшенная копия)
 3) Они нашли баг
 
 Так как мы очень мы используем окружение на пределе его возможностей/очень сильно паралелим то разумеется перед 
 разбором падений мы хотим себя обезапасить от первых двух вариантов падений
 
 Поэтому после прогона мы перепрогоняем упавшие тесты до 5 раз
 Тест не упавший 5 раз не упал!
 
 И что если в итоге упадет даже 1-2% тестов, 180 - 360 тестов, разобрать это все не так то и просто,
 как следствие прогон регрессии занимает 2-3 дня!
 
 [ЭМОЦИОНАЛЬНО!]
 О каком процессе непрерывной поставки можно говорить если у нас по факту 1 окружение результатам которого мы доверяем
 а регрессия на нем занимает до 3 дней?
 
##### Дима:
 [Возможно стоит вынести на отдельный слайд вместо we did ci]
 
 Очевидно что проблема в остутствии непрерывной интеграции!
 
 Но как можно отмасштабировать Build -> Test -> Repeat с такими картами? 
 
 1) 1 окружение
 2) 3 дня на тестирование любого изменения
 3) 7 Команд, 60 человек
 4) Десятки коммитов (более 40 в день, если честно то за 15 мая насчитал 27)
 
 Очевидно что проблема с тестированием, как сильно их не паралель, за 5 минут они не пройдут, потому что они запускаются
 против одного окружения.
 Но и построить десяток окружений для непрерывной интеграции тоже не получится, да и о какой непрерывной интеграции 
 может идти речь если люди поддерживают окружение? если люди его обновляют и поддерживают в рабочем состоянии?
 
 Как отмасштабировать тесты и процесс непрерывной интеграции?
 
 (насколько отмасштабировать? сколько изменений проверять)
 (никто не хочет тестировать свой 5 минутный фикс 2 часа, без сокращения времени обратной связи вообще не взлетит)
 
##### Андрей: 
 Если с окружениями столько проблем почему бы от него не отказаться?
 Давай тестировать без окружений! Ведь существоет множество техник тестирования бекенда.
 
# Блеск и нищита тестирования бекенда

##### Андрей:
 Вот например Shadowing - мы можем просто транслировать наш продакшен трафик на тестовую систему
  и следить за ее поведением

##### Дима:
 Ты же предлагал избавится от окружений, как нам это поможет?
 
##### Андрей: 
 Хорошо, я недавно прочитал несколько статей в тех блоге нетфликса, у них тоже распределенная система, они лидеры рынка
 и уж точно ничего плохого не посоветуют. Так вот как насчет Chaos? - они предлагают случайно ронять на продакшене
 инстансы наших серверов и следить что это не повлияет на наших клиентов...
 
##### Дима:
 Но это не поможет нам протестировать платформу до продакшена, а без этого ее никто не даст задеплоить!
 Ты забыл про SLA? про пять девяток?
 
 Нам нужно что-то быстрое как unit тесты, что-то что не требует окружения (как unit тесты) и при этом проверяет сервисы,
 а не классы и функции.
 
# Компонентное тестирование

##### Дима:

 Компонентные тесты - тестируют отдельные части системы - компоненты.
 Компонентом называется наименьшая часть системы которая может быть протестированна отдельно от всей системы. (очень похоже на unit тестирвоание) 

 Суть это подхода заключается в том, что мы берем какой то компонент, это может быть микросервис или часть сервиса,
 обкладываем его моками и тестируем. 

 Так как мы используем моки для большей части нашей системы, эти тесты быстрее, стабильнее и проще!

 Нам не нужно готовить тестовые данные в десятках баз данных, просто настроить мок.

##### Андрей:
 Это не имеет никакого отношения к реальности (расписать, привести жизненный пример)
 Может ты еще и моки тестировать предлагаешь?
 
##### Дима:
 Помнишь ты расказывал про Shadowing?

##### Андрей:
 Мы конечно можем попробовать:
 1) Записать запросы которые мы отправляем в Mock сервис
 2) Записать ответы от мок сервиса
 3) Поднять реальный сервис
 4) Проиграить все записанные запросы на реальном сервере и сравнить ответы
 
 Вот только кто и где будет хранить записанные от моков запросы и ответы? кто будет их версионировать?
 как мы будем приводить сервис в необходимое состояние (иначе ответы не совпадут, немного расписать)?
 Получается пока больше вопросов чем ответов.
 
##### Дима:
 Оказывается есть фреймворки которые решают все проблемы что ты описал
 [Добавить слайд]
 Pact / Spring Cloud Contract лого и как они решают проблемы(расписать)
 
 И созданы они были для consumer-driven-contracts https://reflectoring.io/7-reasons-for-consumer-driven-contracts/
 (Расписать)
 
 Consumers can drive the API design by building a suite of tests that express what they need from the service.
 
# Как тестировать

##### Андрей:
 Это все хорошо но как тестировать реальное взаимодействие между сервисами(имеет смысл раскрыть что здесь имеется ввиду)
 и интеграцию с инфраструктурой?
 1) Развертывание
 2) Мониторинг
 4) Приёмку
 5) Конфигурацию
 [Зачем тестировать реальные взаимодействия? -> корректная обработка реальных данных]

##### Дима:
 [Подвести Андрея к ответу на вопрос]
 
# Context Driven Environment
 
##### Андрей:
 Почему бы не создавать окружения под функциональность? Допустим если мы тестируем заказ SIP телефонов, 
 нам не нужны сервисы отвечающие за рендеринг факсов или контактный центр.
 (больше примеров, расказать как тестировать конфигурацию, деплой, мониторинг)
 
# PROD-like окружение

 
 
 
