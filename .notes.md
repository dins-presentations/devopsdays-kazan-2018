# Масштабирование процесса непрерывной интеграции

##### Андрей:
 Мы живем в интересное время...
 Еще каких то 5 лет назад я мечтал распаралелить все мои 70 Selenium тестов,
 для того чтоб получать информацию о сборке не за 5 часов а хотя бы за час,
 я мечтал о выделенной виртуалке с докером чтоб на ней развернуть selenium grid и спавнить ноды.
 Но все что было у меня это бесплатная версия тимсити и агенты/тестовое окружение которые делили одну виртуалку.
 Я не мог даже и мечтать построить непрерывную интеграцию...

##### Дима:
 И не говори я тоже мечтал что наступит время когда каждый сможет иметь выделенное окружения
 для тестирования и разработки, когда тесты перестанут падать из-за того что кто-то деплоит новую версию на окружении
 во время прогона регрессии. И вот свершилось, мы встретились в этой компании и что мы видим? Микросервисы, Облака,
 сотни агентов у Jenkins'а. Разумеется в таких тепличных условиях мы смогли реализовать CI для нашего миросервиса
 и мы даже задумывались о внедрении CD, ведь все что от нас требовалось это следовать простым принципам
    
# Принципы CI/CD

##### Дима:
 Встроенное качество/Build-in Quality - Тесты должны быть частью продукта
 и обратная связь от них должна быть быстрой иначе ими никто не будет пользоваться
        
 Ответственность/Everyone is Responsible - Вся команда должна работать на результат.
 Не должно быть ситуаций когда разработчики играют в пинг-поинг тестировщиками. Видим проблему - решаем проблему! 

 Все в виде кода/Version Control Everything - Конфигурация, документация, миграции, все - все должно быть кодом.
    
 Автоматизация/Automate Everything - Сборка, тестирование, релизы, изменения конфигураций, деплой -
 все должно быть автоматизированно! Ручные операции - зло, даже одна ручная операция может сломать весь процесс.
    
 Совершенствование/Continuous Improvement - Никогда не нужно останавливаться на достигнутом, Совершенству нет предела!
 
# CI/CD это просто

##### Андрей:
 [Верхнеуровнего описать процесс разработки арка]
 Действительно реализовать CD для миросервиса очень просто:
 
 Сборка - Пакуем его в контейнер
  
 Тестирование - Пишем сотню тестов на него, этож микросервис в чем проблема автоматизировать 4-5 ендпойнтов,
  Автоматизируем процесс сборки и запуска тестов -> Jenkins pipeline. 
  
 Развертывание - Задеплоить контейнер не проблема. Docker Mesos Marathon k8s
 
 Повторить - И разумеется повторяем. Пока тестов 100-200 и выполняются они за 5 мин. нет проблемы это все повторить.
 
 
##### Дима:
 Мы построили свой маленький уютный мир розовых пони и единорогов... Но мы живем в реальном мире и он ужасен...
 Наверное у каждой компании есть СЕРВИС которым програмисты пугают друг друга? Так вот у нас в компании тестировщики 
 пугают друг дргу регресионным окружением для API платформы. Чтоб понять почему оно страшное надо немного расказать про
 то что же мы разрабатываем и тестируем. 
 
# Сервис интернет-телефонии

##### Андрей:
 Мы разрабатываем облачную систему комуникации, звонки видеоконференции командный мессенджер контакт центр,
 Мы даже умеем отправлять MMS и Факсы!
  
 И да наша система построенна на принципах SOA  

# Архитектура

##### Андрей:
 На данный момент у нас более 170 сервисов... И нам сказали построить CD для сердца нашей API платформы.

# Платформа API

##### Андрей:
 API платформа предоставляет возможность нашим внутренним и внешним разработчикам а так же другим компаниям
 интегрироваться с нашей системой.
 На данный момент платформа насчитывает порядка 35 сервисов, которые разрабатывают 60 человек (7 команд).
 
 [Показать что говорить то мы будем про сервис над которым работают все 7 команд]

# Окружения 
 У нас очень сложное окружение, хоть мы и разрабатываем 35 сервисов, для того чтоб все работало нам нужно задеплоить 80 сервисов.
 И да у каждой команды есть свое выделенное окружение а так же 3 окружения для релизных активностей
 и непрерывной интеграции.
 
 [Вопрос залу]
 Как вы думайте сколько времени занимает деплой 80 сервисов?
 Когда я только пришел в компанию мне предложили самому попробовать обновить его, и это заняло 2 недели!
 
 Разумеется поддерживать такую инфраструктуру каманда разработки не сможет, кто-то же должен писать новый код
 и тестировать его! И ладно в платформе окружений 10, если посмотреть в масштабах компании их около СОТНИ... 
 и их нужно поддерживать а это значит без выделенной команды которая только и будет что поддерживать тестовые окружения
 не обойтись! И все равно, несмотря на выделенную команду мы тоже поддерживаем эти окружения.  

# Регрессия
##### Андрей:
 А выглядит оно очень просто:
 1) обновляем окружение до необходимого состояния
 2) Проверяем что оно работает
 3) Готовим тестовые данные, а это тот еще квест, разложить все по десяткам баз данных и синхронизировать. Мы даже написали отдельный сервис 
    который этим занимается.
 4) Запускаем 18 000 e2e тестов
  
 И все-го то через 2 часа мы могли бы получить результат... 
 Но очень часто тесты падают из-за проблем с окружением
 
 Тест не упавший 5 раз не упал! 
 
 А что если в итоге упадет даже 1-2% тестов, разобрать 360 тестов не так то и просто,
  как следствие регрессия занимает 2-3 дня!
  
 О каком процессе непрерывной поставки можно говорить если у нас по факту у нас есть только 1 окружение
 результатам которого мы доверяем и регрессия на нем занимает до 3 дней?

# Постоянная доступность

##### Дима:
 А еще у нас "Соглашение об уровне услуг 99 999" это значит что все и всегда должно работать! 
 BC больше регрессии для бога регрессии

# Постановка

##### Дима:
 И этот сервис нам нужно поставлять на продакшен хотя бы за 1 день!
 а ведь над ним работают 60 человек -> десятки изменений в день!

 Очевидно что проблема с тестированием, как сильно их не паралель, за 5 минут они не пройдут, потому что они запускаются
 против одного окружения.
 Но и построить десяток окружений для непрерывной интеграции тоже не получится.
 
 Как отмасштабировать тесты и процесс непрерывной интеграции? чтоб поставлять любое изменение хотя бы за 1 день?
 
##### Андрей: 
 Если с окружениями столько проблем почему бы от него не отказаться?
 Давай тестировать без окружений! Ведь существоет множество техник тестирования бекенда.
 
# Блеск и нищита тестирования бекенда

##### Андрей:
 Вот например Shadowing - мы можем просто транслировать наш продакшен трафик на тестовую систему
  и следить за ее поведением

##### Дима:
 Ты же предлагал избавится от окружений, как нам это поможет?
 
##### Андрей: 
 Хорошо, я недавно прочитал несколько статей в тех блоге нетфликса, у них тоже распределенная система, они лидеры рынка
 и уж точно ничего плохого не посоветуют. Так вот как насчет Chaos? - они предлагают случайно ронять на продакшене
 инстансы наших серверов и следить что это не повлияет на наших клиентов...
 
##### Дима:
 Но это не поможет нам протестировать платформу до продакшена, а без этого ее никто не даст задеплоить!
 Ты забыл про SLA? про пять девяток?
 
 Нам нужно что-то быстрое как unit тесты, что-то что не требует окружения (как unit тесты) и при этом проверяет сервисы,
 а не классы и функции.
 
# Компонентное тестирование

##### Дима:

 Компонентные тесты - тестируют отдельные части системы - компоненты.
 Компонентом называется наименьшая часть системы которая может быть протестированна отдельно от всей системы. (очень похоже на unit тестирвоание) 

 Суть это подхода заключается в том, что мы берем какой то компонент, это может быть микросервис или часть сервиса,
 обкладываем его моками и тестируем. 

 Так как мы используем моки для большей части нашей системы, эти тесты быстрее, стабильнее и проще!

 Нам не нужно готовить тестовые данные в десятках баз данных, просто настроить мок.

##### Андрей:
 Это не имеет никакого отношения к реальности (расписать, привести жизненный пример)
 Может ты еще и моки тестировать предлагаешь?
 
##### Дима:
 Помнишь ты расказывал про Shadowing?

##### Андрей:
 Мы конечно можем попробовать:
 1) Записать запросы которые мы отправляем в Mock сервис
 2) Записать ответы от мок сервиса
 3) Поднять реальный сервис
 4) Проиграить все записанные запросы на реальном сервере и сравнить ответы
 
 Вот только кто и где будет хранить записанные от моков запросы и ответы? кто будет их версионировать?
 как мы будем приводить сервис в необходимое состояние (иначе ответы не совпадут, немного расписать)?
 Получается пока больше вопросов чем ответов.
 
##### Дима:
 Оказывается есть фреймворки которые решают все проблемы что ты описал
 [Добавить слайд]
 Pact / Spring Cloud Contract лого и как они решают проблемы(расписать)
 
 И созданы они были для consumer-driven-contracts https://reflectoring.io/7-reasons-for-consumer-driven-contracts/
 (Расписать)
 
 Consumers can drive the API design by building a suite of tests that express what they need from the service.
 
# Как тестировать

##### Андрей:
 Это все хорошо но как тестировать реальное взаимодействие между сервисами(имеет смысл раскрыть что здесь имеется ввиду)
 и интеграцию с инфраструктурой?
 1) Развертывание
 2) Мониторинг
 4) Приёмку
 5) Конфигурацию
 [Зачем тестировать реальные взаимодействия? -> корректная обработка реальных данных]

##### Дима:
 [Подвести Андрея к ответу на вопрос]
 
# Context Driven Environment
 
##### Андрей:
 Почему бы не создавать окружения под функциональность? Допустим если мы тестируем заказ SIP телефонов, 
 нам не нужны сервисы отвечающие за рендеринг факсов или контактный центр.
 (больше примеров, расказать как тестировать конфигурацию, деплой, мониторинг)
 (Заход про то что все равно нужно тестировать на прод лайк окружении)
 
# PROD-like окружение

# Процесс тестирования

# Постановка проблемы
 Мы проделали большую работу, перекроили наш процесс тестирования, сделали его сложнее. Да, он стал лучше,
 он помог нам:
 1) Сократить размер сьюта который требует реальное окружение (цифры! без цыфр плохо)
 2) Получать фидбек от тестов раньше и точнее
 3) [Какой то еще профит]
  
 Но если вспомнить нашу цель - Мы хотели чтоб у каждого было свое окружение для тестирования, мы хотели избавится 
 от очередей при тестировании на окружении, но ситуация кардинальным образом не поменялась:
 
 1) 1 окружение
 2) [ X ] на тестирование любого изменения
 3) 7 Команд, 60 человек
 4) Десятки коммитов (более 40 в день, если честно то за 15 мая насчитал 27)
 
 Так как же нам отмасштабировать CI, как нам тестировать десятки изменений [Поработать над формулировкой]???
 
 Когда мы занимались проблемами масштабирования Jenkins  мы так же заметили одну очень интересную презентацию
 https://www.cloudbees.com/sites/default/files/2014-0625-berlin-robert_martin-multi_stage_ci_0.pdf

 В ней расказывалось как посмотрить CI для встраиваемых (Embedded) систем... оказывается ПО для встраиваемых систем
 машины/телефоны/ еще примеры очень пхоже на микросервисы/сервис ориентированное по

 У них так же есть компоненты из которых собираются подсистемы, из которых собираются системы из которых собирается продукт

 И У них такие же проблемы с окружениями, (сотни машин для тестирования одного компонента никто не предоставит)

 И они предложили следующее решение!
 
# Multi-stage continuous integration
Multi-stage continuous integration
# MSCI
MSCI - Это подход в рамках которого компонент проходит через несколько стейджей на своем пути от коммита до "релиза"
и на каждом из них мы верифицируем его работоспособность. (Пока ничего нового)

И на каждом следующем стейдже мы интегрируем результаты предудущих стейджей и првоеряем их совместно.

Т.е. интегрируем компонент в подсистему подсистему в систему.

Такой подход позволяет интегрировать больше изменений за раз и при этом на каждом стейдже мы гарантируем определенный уровень качества.
А так же огранициваем скоуп интеграции для того чтоб было легче локализовать проблему.

При этом данный подход не имеет ничего общего с тем чтоб взять все изменения и прогнать для них огромный тестовый сьют.

И разумеется для того чтоб это все взлетело необходим высокий уровень автоматизации процесса.

В первую очередь нужно хорошо подумать как будет устроен процесс промоушина артефактов между стейджами.

# Контроль версий кода, артефактов и конфигураций
Описать как промоутить артефакты и тригерить стейджи

# Планирования изменений и релизов

Способность выпускать новые версии быстрее, накладывает жесткие требования на управление релизами и выкатками.
Мало знать что и где с какой версией задеплоено, чтобы правильно организовать процесс тестирования,
нужны еще и данные о том что, где и когда будет задеплоено. Эта информация нужна в реальном времени и должна
автоматически доставляться на все уровни интеграции, чтобы правильно формировать интеграционное окружение.

# Автоматический деплой

Без него никак, и хорошо если у вас только микросервисы в Docker тогда у вас уже есть единый способ деплоя
а нам пришлось написать свою систему так как у нас зоопарк артефактов.

Так же нам необходимо иметь инструмент хранения конфигурации.

# Система автоматизации процессов

Jenkins. Он обоадает самым большим сообществом пользователей и разработчиков,
а огромное количесвто плагинов позваляет реализовать самые смелые фантазии.

# MSCI Pipeline

Описание пайплайна, гейтов и прочего

# Что получилось?

Мы отмасштабировали CI, и способны тестировать десятки изменений [Поработать над формулировкой]???

Потому что других способов для больших распределенных систем нет. 
Тестировать на одном окружении долго и дорого. А построить и поддерживать много таких окружений еще дороже.
Единственный способ - это проверять множество изменений вместе за один раз.
Но для этого, чтобы уменьшить риски и проблемы на поздних этапах, нужно гарантировать качество вносимых изменений 
на более ранних этапах. Чтобы такой подход работал требуется высокий уровень автоматизации,
так как потребуется выполнять большое количество одинаковых действий.

# CI — CD — DevOps

Заключительнео слово
