# Масштабирование процесса непрерывной интеграции

##### Андрей:
 Мы живем в интересное время...
 Еще каких то 5 лет назад я мечтал распаралелить все мои 70 Selenium тестов,
 для того чтоб получать информацию о сборке не за 5 часов а хотя бы за час,
 я мечтал о выделенной виртуалке с докером чтоб на ней развернуть selenium grid и спавнить ноды.
 Но все что было у меня это бесплатная версия тимсити и агенты/тестовое окружение которые делили одну виртуалку.
 Я не мог даже и мечтать построить непрерывную интеграцию...

##### Дима:
 И не говори я тоже мечтал что наступит время когда каждый сможет иметь выделенное окружения
 для тестирования и разработки, когда тесты перестанут падать из-за того что кто-то деплоит новую версию на окружении
 во время прогона регрессии. И вот свершилось, мы встретились в этой компании и что мы видим? Облака, сотни агентов у
 Jenkins'а. Разумеется в таких тепличных условиях мы смогли реализовать CI для нашего проекта
 и мы даже задумывались о внедрении CD, ведь все что от нас требовалось это следовать простым принципам
    
# Принципы CI/CD

##### Дима:
 Встроенное качество/Build-in Quality - Тесты должны быть частью продукта
 и обратная связь от них должна быть быстрой иначе ими никто не будет пользоваться
        
 Ответственность/Everyone is Responsible - Вся команда должна работать на результат.
 Не должно быть ситуаций когда разработчики играют в пинг-поинг тестировщиками. Видим проблему - решаем проблему! 

 Все в виде кода/Version Control Everything - Конфигурация, документация, миграции, все - все должно быть кодом.
    
 Автоматизация/Automate Everything - Сборка, тестирование, релизы, изменения конфигураций, деплой -
 все должно быть автоматизированно! Ручные операции - зло, даже одна ручная операция может сломать весь процесс.
    
 Совершенствование/Continuous Improvement - Никогда не нужно останавливаться на достигнутом, Совершенству нет предела!
 
# CI/CD это просто

##### Андрей:
 Мы работали(работаем) в команде из 6 человек, 3 разработчика, 2 тестировщика и тимлид. Мы разрабатывали(разрабатываем)
 микросервис для асинхронных операций
 
 Сборка - Что может быть проще чем положить jar'ник в контейнер с java и запушить его в regestry,
  (c этим даже программист может справится/gradle build или maven build + подключить плагин)
  
 Тестирование - Мы написали тесты, этож микросервис в чем проблема автоматизировать 4-5 ендпойнтов, мы объединили
  это все в папйлайн и сборка + тестирование у нас занимало/занимает каких то 5 минут.
  
 Развертывание - Задеплоить контейнер не проблема, но у нас есть своя система для деплоя, так как у нас не только
  контейнеры но и виртуальные машины на linux/windows а единый способ деплоя для всего в больших системах просто необходим.
  Но и с этой задачей мы справились!  

 Кажется пришло время внедрить это решение и мы собрали митинг, продемонстрировали наше решение...
 
##### Дима:
 Но как оказалось просто так задеплоить в продакшн ничего нельзя.
 Наше соглашение об уровне предоставления услуг подразумевает доступность пять девяток и для поддержки 
 такого уровня у нас реализованны "почти" все процессы описанные в ITSM (IT Service Management) а именно:
 1) управления инцидентами
 2) управления проблемами
 3) управления конфигурациями
 4) управления изменениями
 5) управления релизами
 6) управления доступностью
 
 То есть процесс несколько сложнее чем нам казалось, а до кучи никому не интересно внедрение CD для нашего микросервиса.
 Он уже на продакшене, и ни у кого нет планов вносить в него изменения...  

##### Андрей:
 Тем не менее мы смогли всех заинтриговать данным подходом и нам предложили построить CD для сердца нашей API платформы
 А это не микросервис у которого 1-2 интеграции. (Переход на продукт)
 
# Сервис интернет-телефонии

##### Андрей:
 Мы разрабатываем облачную систему комуникации, звонки видеоконференции командный мессенджер контакт центр,
 Мы даже умеем отправлять MMS и Факсы!
  
 И да наша система построенна на принципах SOA   
 
# Архитектура
  
##### Андрей:
 На данный момент у нас более 170 сервисов... А строить CD мы будем для сервиса который предоставляет большую часть API.

# Платформа API

##### Андрей:
 Вот он (показать на PAS), помимо сервиса я так же подсветил сервисы с которыми он непосредственно взаимодействует.
 API платформа предоставляет возможность нашим внутренним и внешним разработчикам а так же другим компаниям
 интегрироваться с нашей системой.
 На данный момент платформа насчитывает порядка 35 сервисов, которые разрабатывают 60 человек (7 команд).
 
 [показать масштаб, микросервис vs платформа, указать что тут уже масштаб чувствуется]

##### Дима: 
 И  для разработки и для тестирования нам разумеется требуется окружение:
 
# Тестовые окружения

##### Дима:
 Оно очень сложное, хоть мы и разрабатываем 35 сервисов, для того чтоб все работало нам нужно задеплоить 80 сервисов.
 И да у каждой команды есть свое выделенное окружение а так же 3 окружения для релизных активностей
 и непрерывной интеграции.
 
 [Вопрос залу]
 Как вы думайте сколько времени занимает деплой 80 сервисов?
 2 дня работы инженера, если в дата центре есть ресурсы, ведь это не 2 ядра 4 гига, это 130 вируальных ядер,
 180 GB оперативной памяти. А если их нет? то тут уж как повезет, ведь поставка нового оборудовоания в датацентр
 и интеграция его в нашу систему может занять до полу года.
 
 Разумеется поддерживать такую инфраструктуру каманда разработки не сможет, кто-то же должен писать новый код
 и тестировать его! И ладно в платформе окружений 10, если посмотреть в масштабах компании их около СОТНИ... 
 и их нужно поддерживать а это значит без выделенной команды которая только и будет что поддерживать тестовые окружения
 не обойтись!
 
 Обновление даже одного сервиса в распределенной системе это всегда боль!
 1) Вам нужно найти все сервисы которые с ним взаимодействуют
 2) Вам нужно найти все сервисы с которыми он взаимодействуют
 3) Проверить не требуется ли обновление этих сервисов
 4) вернуться к пункту 1
 5) Задеплоить все в правильном попрядке
 6) Проверить работает ли после деплоя окружения (прогнать PDV для окружения)
 
 И не дай бог что-то не работает, пойди потом найди проблему!
 Как же по вашему выглядит регрессионное тестирвоание на таком окружении?      
 
# Регрессионное тестирование

##### Андрей:
 А выглядит оно очень просто:
 1) обновляем окружение до необходимого состояния
 2) Проверяем что оно работает (вообщем все что Дима уже расказал)
 3) Готовим тестовые данные, а это тот еще квест, разложить данные по десяткам баз. Мы даже написали отдельный сервис 
    который этим занимается.
 4) Запускаем 18 000 e2e тестов
 
 И все-го то через 2 часа мы могли бы получить результат...
 [Вопрос залу]
 Почему могут падать тесты? 
 1) Они нашли баг
 2) Проблемы с окружением/что-то не додеплоили или заделоили не то/ какой то сервис упал по непонятным причинам
 3) Проблемы с тестом
  
 А почему могут падать тесты если мы их распаралелим (200 rps / 1 500 000 запросов за регрессию,
  более 100 паралельных тестов)
 1) Проблемы с тестом - тесты начинаю мешать друг другу
 2) Проблемы с окружением, где то таймаут слишком маленький и из-за нагрузки что-то может не работать (это же уменьшенная копия)
 3) Они нашли баг
 
 Так как мы очень мы используем окружение на пределе его возможностей/очень сильно паралелим то разумеется перед 
 разбором падений мы хотим себя обезапасить от первых двух вариантов падений
 
 Поэтому после прогона мы перепрогоняем упавшие тесты до 5 раз
 Тест прошедший на 5 раз не считается упавшим (забыл шутку)
 
 И что если в итоге упадет даже 1-2% тестов, 180 - 360 тестов, разобрать это все не так то и просто,
 как следствие прогон регрессии занимает 2-3 дня!
 
##### Дима:
 [Возможно стоит вынести на отдельный слайд вместо we did ci]
 О каком процессе непрерывной поставки можно говорить если у нас по факту 1 окружение результатам которого мы доверяем
 а регрессия на нем занимает до 3 дней? Как в таких условиях можно построить процесс непрерывной интеграции?
 
 1) 1 окружение
 2) 3 дня на тестирование любого изменения
 3) 7 Команд, 60 человек
 4) Десятки коммитов (более 40 в день, если честно то за 15 мая насчитал 27)  
  

 
 
 
